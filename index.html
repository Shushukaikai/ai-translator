<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI语音翻译助手（Whisper版）</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6">
  <h1 class="text-2xl font-bold mb-4">🎤 AI语音翻译助手（Whisper版）</h1>
  <button id="recordBtn" class="bg-blue-500 text-white px-4 py-2 rounded mb-4">🎙 开始录音</button>
  <div id="status" class="text-sm text-gray-500 mb-2">等待录音中...</div>
  <div id="result" class="text-base font-semibold mb-2"></div>
  <div id="translated" class="text-green-600 font-bold text-lg mb-4"></div>

  <script>
    let mediaRecorder;
    let audioChunks = [];

    const recordBtn = document.getElementById('recordBtn');
    const status = document.getElementById('status');
    const result = document.getElementById('result');
    const translated = document.getElementById('translated');

    recordBtn.onclick = async () => {
      if (!navigator.mediaDevices) {
        alert("你的浏览器不支持录音");
        return;
      }

      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];

      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
      mediaRecorder.onstop = async () => {
        const blob = new Blob(audioChunks, { type: 'audio/webm' });
        status.innerText = '上传中...';

        const formData = new FormData();
        formData.append('file', blob, 'audio.webm');

        // 调用我已部署的 DeepSeek Whisper + 翻译 API
        const res = await fetch('https://whisper-deepseek-demo.vercel.app/api/whisper', {
          method: 'POST',
          body: formData
        });

        const data = await res.json();
        result.innerText = '你说的是：' + data.text;
        translated.innerText = '翻译：' + data.translation;

        const utter = new SpeechSynthesisUtterance(data.translation);
        utter.lang = /[\u4e00-\u9fa5]/.test(data.translation) ? 'zh-CN' : 'en-US';
        speechSynthesis.speak(utter);
      };

      mediaRecorder.start();
      status.innerText = '🎙 录音中...请开始说话';
      recordBtn.innerText = '🛑 停止录音';

      recordBtn.onclick = () => {
        mediaRecorder.stop();
        stream.getTracks().forEach(track => track.stop());
        status.innerText = '⏳ 处理中...';
        recordBtn.innerText = '🎙 重新录音';
        recordBtn.onclick = recordBtn.onclick = () => location.reload(); // 重新绑定
      };
    };
  </script>
</body>
</html>
